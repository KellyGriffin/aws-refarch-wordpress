AWSTemplateFormatVersion: 2010-09-09
Description: >-
  Reference Architecture to host WordPress on AWS - Creates WordPress web Auto
  Scaling group
Metadata:
  Authors:
    Description: 'Darryl Osborne (darrylo@amazon.com), David McGovern (gov@amazon.com)'
  License:
    Description: >-
      Copyright 2020 Amazon.com, Inc. and its affiliates. All Rights Reserved.
      SPDX-License-Identifier: MIT-0
  'AWS::CloudFormation::Interface':
    ParameterGroups:
      - Label:
          default: Web Parameters
        Parameters:
          - PHPVersion
          - PHPIniOverride
          - EC2KeyName
          - WebInstanceType
          - WebAsgMax
          - WebAsgMin
          - WebSecurityGroup
          - NumberOfSubnets
          - Subnet
          - PublicAlbTargetGroupArn
          - PublicAlbHostname
          - SslCertificate
      - Label:
          default: WordPress Parameters
        Parameters:
          - WPVersion
          - WPTitle
          - WPDomainName
          - WPDirectory
          - WPAdminUsername
          - WPAdminPassword
          - WPAdminEmail
          - WPLocale
      - Label:
          default: Database Parameters
        Parameters:
          - DatabaseClusterEndpointAddress
          - DatabaseName
          - DatabaseMasterUsername
          - DatabaseMasterPassword
      - Label:
          default: File System Parameters
        Parameters:
          - ElasticFileSystem
    ParameterLabels:
      PHPIniOverride:
        default: AWS php.ini Overrides
      DatabaseClusterEndpointAddress:
        default: DB Cluster Endpoint Address
      DatabaseMasterUsername:
        default: DB Master Username
      DatabaseMasterPassword:
        default: DB Master Password
      DatabaseName:
        default: DB Name
      ElasticFileSystem:
        default: EFS File System
      EC2KeyName:
        default: Existing Key Pair
      NumberOfSubnets:
        default: Number of subnets
      PHPVersion:
        default: PHP Version
      PublicAlbTargetGroupArn:
        default: Public Alb Target Group Arn
      PublicAlbHostname:
        default: Public Alb Hostname
      SslCertificate:
        default: ACM Cert attached to Public Alb
      Subnet:
        default: Subnets
      WebAsgMax:
        default: Web ASG Max
      WebAsgMin:
        default: Web ASG Min
      WebInstanceType:
        default: Web Instance Type
      WebSecurityGroup:
        default: Web Security Group
      WPAdminEmail:
        default: Admin Email
      WPAdminPassword:
        default: Admin Password
      WPAdminUsername:
        default: Admin Username
      WPDirectory:
        default: Site Directory
      WPDomainName:
        default: Site Domain
      WPLocale:
        default: Language Code
      WPTitle:
        default: Site Title
      WPVersion:
        default: WordPress Version
  'AWS::CloudFormation::Designer':
    32bb6c38-1de5-4720-a1ec-43c84c6a6f61:
      size:
        width: 60
        height: 60
      position:
        x: 60
        'y': 90
      z: 1
      embeds: []
    fa8d551f-0cc6-4363-9da6-6e533fbf6dc0:
      size:
        width: 60
        height: 60
      position:
        x: 180
        'y': 90
      z: 1
      embeds: []
      isassociatedwith:
        - 32bb6c38-1de5-4720-a1ec-43c84c6a6f61
    d00ad01c-fa44-49bb-829a-ffb890e3223b:
      size:
        width: 60
        height: 60
      position:
        x: 60
        'y': 210
      z: 1
      embeds: []
    1c425a30-ac1e-43bc-b916-1778f9606f70:
      size:
        width: 60
        height: 60
      position:
        x: 180
        'y': 210
      z: 1
      embeds: []
    7124949a-aba7-4cfd-b132-e4c1b16f7b49:
      size:
        width: 60
        height: 60
      position:
        x: 300
        'y': 90
      z: 1
      embeds: []
    06bfa836-7465-42ba-b6ca-a527b1e774f1:
      size:
        width: 60
        height: 60
      position:
        x: 300
        'y': 210
      z: 1
      embeds: []
      isassociatedwith:
        - d00ad01c-fa44-49bb-829a-ffb890e3223b
Parameters:
  DatabaseClusterEndpointAddress:
    Description: The RDS cluster endpoint address.
    Type: String
  DatabaseMasterUsername:
    AllowedPattern: '^([a-zA-Z0-9]*)$'
    Description: The Amazon RDS master username.
    ConstraintDescription: >-
      Must contain only alphanumeric characters and be at least 8 characters,
      max 16 characters.
    MaxLength: 16
    MinLength: 1
    Type: String
  DatabaseMasterPassword:
    AllowedPattern: '^([a-z0-9A-Z`~!#$%^&*()_+,\\-])*$'
    ConstraintDescription: >-
      Must be letters (upper or lower), numbers, and these special characters
      '_'`~!#$%^&*()_+,-
    Description: The Amazon RDS master password.
    MaxLength: 41
    MinLength: 8
    NoEcho: true
    Type: String
  DatabaseName:
    AllowedPattern: '^([a-zA-Z0-9]*)$'
    Description: The Amazon RDS master database name.
    Type: String
  ElasticFileSystem:
    AllowedPattern: '^(fs-)([a-z0-9]{8})$'
    Description: The Amazon EFS file system id.
    Type: String
  EC2KeyName:
    AllowedPattern: '^([a-zA-Z0-9 @.`~!#$%^&*()_+,\\-])*$'
    ConstraintDescription: 'Must be letters (upper or lower), numbers, and special characters.'
    Description: >-
      Name of an EC2 KeyPair. Your bastion & Web instances will launch with this
      KeyPair.
    Type: 'AWS::EC2::KeyPair::KeyName'
  NumberOfSubnets:
    AllowedValues:
      - 2
      - 3
      - 4
      - 5
      - 6
    Default: 3
    Description: >-
      Number of subnets. This must match your selections in the list of subnets
      below.
    Type: String
  PHPIniOverride:
    Description: >-
      Full Amazon S3 https path to a php.ini override file (e.g.
      https://s3.amazonaws.com/aws-refarch/wordpress/latest/bits/20-aws.ini)
    Type: String
  PHPVersion:
    AllowedValues:
      - 7
      - 7.1
      - 7.3
    Default: 7.3
    Description: The version of PHP to install.
    Type: String
  PublicAlbTargetGroupArn:
    Description: The public application load balancer target group arn.
    Type: String
  PublicAlbHostname:
    Description: >-
      The hostname of the public ALB http form (e.g.
      http://abdc-12345-xyz.<region>.elb.amazonaws.com)
    Type: String
  SslCertificate:
    AllowedValues:
      - true
      - false
    Default: false
    Description: Is there an ACM SSL Certificate attached to the Public Alb?
    Type: String
  Subnet:
    Description: >-
      Select existing subnets. The number selected must match the number of
      subnets above. Subnets selected must be in separate AZs.
    Type: 'List<AWS::EC2::Subnet::Id>'
  WebAsgMax:
    AllowedPattern: '^((?!0$)[1-2]?[0-9]|30)$'
    ConstraintDescription: Must be a number between 1 and 30.
    Default: 4
    Description: >-
      Specifies the maximum number of EC2 instances in the Web Autoscaling
      Group.
    Type: String
  WebAsgMin:
    AllowedPattern: '^([0-0]?[0-9]|10)$'
    ConstraintDescription: Must be a number between 0 and 10.
    Default: 2
    Description: >-
      Specifies the minimum number of EC2 instances in the Web Autoscaling
      Group.
    Type: String
  WebInstanceType:
    AllowedValues:
      - t3a.nano
      - t3a.micro
      - t3a.small
      - t3a.medium
      - t3a.large
      - t3a.xlarge
      - t3a.2xlarge
      - m5a.large
      - m5a.xlarge
      - m5a.2xlarge
      - m5a.4xlarge
      - m5a.12xlarge
      - m5a.24xlarge
    ConstraintDescription: Must be a valid Amazon EC2 instance type.
    Default: t3a.large
    Description: The Amazon EC2 instance type for your web instances.
    Type: String
  WebSecurityGroup:
    Description: Select the web security group.
    Type: 'AWS::EC2::SecurityGroup::Id'
  WPAdminEmail:
    AllowedPattern: >-
      ^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$
    Description: The WordPress admin email address.
    Type: String
  WPAdminPassword:
    AllowedPattern: '^([a-zA-Z0-9`~!#$%^&*()_+,\\-])*$'
    ConstraintDescription: >-
      Must be letters (upper or lower), numbers, and these special characters
      '_'`~!#$%^&*()_+,-
    Description: The WordPress admin password.
    Type: String
    NoEcho: true
  WPAdminUsername:
    AllowedPattern: '^([a-zA-Z0-9])([a-zA-Z0-9_-])*([a-zA-Z0-9])$'
    Description: The WordPress admin username.
    Type: String
  WPDirectory:
    AllowedPattern: '^([a-zA-Z0-9])([a-zA-Z0-9_-])*([a-zA-Z0-9])$'
    Description: The WordPress site directory.
    Type: String
  WPDomainName:
    AllowedPattern: >-
      ^$|(([a-zA-Z0-9]|[a-zA-Z0-9][a-zA-Z0-9\-]*[a-zA-Z0-9])\.)*([A-Za-z0-9]|[A-Za-z0-9][A-Za-z0-9\-]*[A-Za-z0-9])$
    Description: >-
      [ Optional ] The main domain name of the WordPress site (e.g.
      example.com). Leave empty to use the ALB DNS name for the WordPress site.
    Type: String
  WPLocale:
    Description: >-
      The main language of the WordPress site, as per
      https://codex.WordPress.org/Installing_WordPress_in_Your_Language. The
      default is 'en_GB'.
    Type: String
    Default: en_GB
  WPTitle:
    AllowedPattern: '^([a-zA-Z0-9])([a-zA-Z0-9 _-]*)([a-zA-Z0-9])$'
    Description: The WordPress website title.
    Type: String
  WPVersion:
    AllowedValues:
      - latest
      - nightly
      - 4.5
      - 4.6
      - 4.7
      - 4.8
      - 4.9
    Default: latest
    Description: >-
      The WordPress version (make sure this version is compatible with the PHP
      version selected above).
    Type: String
Conditions:
  NoSslCertificate: !Equals 
    - false
    - Ref: SslCertificate
  NumberOfSubnets1: !Equals 
    - 1
    - Ref: NumberOfSubnets
  NumberOfSubnets2: !Equals 
    - 2
    - Ref: NumberOfSubnets
  NumberOfSubnets3: !Equals 
    - 3
    - Ref: NumberOfSubnets
  NumberOfSubnets4: !Equals 
    - 4
    - Ref: NumberOfSubnets
  NumberOfSubnets5: !Equals 
    - 5
    - Ref: NumberOfSubnets
  NumberOfSubnets6: !Equals 
    - 6
    - !Ref NumberOfSubnets
  PHP55: !Equals 
    - 5.5
    - Ref: PHPVersion
  PHP56: !Equals 
    - 5.6
    - Ref: PHPVersion
  PHP70: !Equals 
    - 7
    - !Ref PHPVersion
  PHP73: !Equals 
    - 7.3
    - !Ref PHPVersion
  Subnet0: !Or 
    - !Condition NumberOfSubnets1
    - !Condition NumberOfSubnets2
    - !Condition NumberOfSubnets3
    - !Condition NumberOfSubnets4
    - !Condition NumberOfSubnets5
    - !Condition NumberOfSubnets6
  Subnet1: !Or 
    - !Condition NumberOfSubnets2
    - !Condition NumberOfSubnets3
    - !Condition NumberOfSubnets4
    - !Condition NumberOfSubnets5
    - !Condition NumberOfSubnets6
  Subnet3a: !Or 
    - !Condition NumberOfSubnets3
    - !Condition NumberOfSubnets4
    - !Condition NumberOfSubnets5
    - !Condition NumberOfSubnets6
  Subnet3: !Or 
    - !Condition NumberOfSubnets4
    - !Condition NumberOfSubnets5
    - !Condition NumberOfSubnets6
  Subnet4: !Or 
    - !Condition NumberOfSubnets5
    - !Condition NumberOfSubnets6
  Subnet5: !Condition NumberOfSubnets6
  NoWPDomainName: !Equals 
    - ''
    - Ref: WPDomainName
Mappings:
  RegionMap:
    ap-northeast-1:
      AMI: ami-0a1c2ec61571737db
    ap-northeast-2:
      AMI: ami-1196317f
    ap-south-1:
      AMI: ami-d5c18eba
    ap-southeast-1:
      AMI: ami-0615132a0f36d24f4
    ap-southeast-2:
      AMI: ami-088ff0e3bde7b3fdf
    ca-central-1:
      AMI: ami-d29e25b6
    eu-central-1:
      AMI: ami-bf2ba8d0
    eu-west-1:
      AMI: ami-1a962263
    eu-west-2:
      AMI: ami-e7d6c983
    sa-east-1:
      AMI: ami-286f2a44
    us-east-1:
      AMI: ami-55ef662f
    us-east-2:
      AMI: ami-15e9c770
    us-west-1:
      AMI: ami-a51f27c5
    us-west-2:
      AMI: ami-bf4193c7
Resources:
  WebInstanceProfile:
    Type: 'AWS::IAM::InstanceProfile'
    Properties:
      Path: /
      Roles:
        - !Ref WebInstanceRole
    Metadata:
      'AWS::CloudFormation::Designer':
        id: fa8d551f-0cc6-4363-9da6-6e533fbf6dc0
  WebInstanceRole:
    Type: 'AWS::IAM::Role'
    Properties:
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - ec2.amazonaws.com
            Action:
              - 'sts:AssumeRole'
      Path: /
      Policies:
        - PolicyName: logs
          PolicyDocument:
            Version: 2012-10-17
            Statement:
              - Effect: Allow
                Action:
                  - 'logs:CreateLogGroup'
                  - 'logs:CreateLogStream'
                  - 'logs:PutLogEvents'
                  - 'logs:DescribeLogStreams'
                Resource:
                  - 'arn:aws:logs:*:*:*'
    Metadata:
      'AWS::CloudFormation::Designer':
        id: 32bb6c38-1de5-4720-a1ec-43c84c6a6f61
  WebAutoScalingGroup:
    Type: 'AWS::AutoScaling::AutoScalingGroup'
    Properties:
      Cooldown: 60
      HealthCheckGracePeriod: 120
      HealthCheckType: ELB
      LaunchConfigurationName: !If 
        - PHP55
        - !Ref WebLaunchConfiguration55
        - !If 
          - PHP56
          - !Ref WebLaunchConfiguration56
        - !If
          - PHP73
          - !Ref WebLaunchConfiguration70
          - !Ref WebLaunchConfiguration73
         
      MaxSize: !Ref WebAsgMax
      MinSize: !Ref WebAsgMin
      Tags:
        - Key: Name
          Value: !Join 
            - ''
            - - 'Web ASG / '
              - !Ref 'AWS::StackName'
          PropagateAtLaunch: true
      TargetGroupARNs:
        - !Ref PublicAlbTargetGroupArn
      VPCZoneIdentifier: !If 
        - NumberOfSubnets1
        - - !Select 
            - 0
            - !Ref Subnet
        - !If 
          - NumberOfSubnets2
          - - !Select 
              - 0
              - !Ref Subnet
            - !Select 
              - 1
              - !Ref Subnet
          - !If 
            - NumberOfSubnets3
            - - !Select 
                - 0
                - !Ref Subnet
              - !Select 
                - 1
                - !Ref Subnet
              - !Select 
                - 2
                - !Ref Subnet
            - !If 
              - NumberOfSubnets4
              - - !Select 
                  - 0
                  - !Ref Subnet
                - !Select 
                  - 1
                  - !Ref Subnet
                - !Select 
                  - 2
                  - !Ref Subnet
                - !Select 
                  - 3
                  - !Ref Subnet
              - !If 
                - NumberOfSubnets5
                - - !Select 
                    - 0
                    - !Ref Subnet
                  - !Select 
                    - 1
                    - !Ref Subnet
                  - !Select 
                    - 2
                    - !Ref Subnet
                  - !Select 
                    - 3
                    - !Ref Subnet
                  - !Select 
                    - 4
                    - !Ref Subnet
                - - !Select 
                    - 0
                    - !Ref Subnet
                  - !Select 
                    - 1
                    - !Ref Subnet
                  - !Select 
                    - 2
                    - !Ref Subnet
                  - !Select 
                    - 3
                    - !Ref Subnet
                  - !Select 
                    - 4
                    - !Ref Subnet
                  - !Select 
                    - 5
                    - !Ref Subnet
    CreationPolicy:
      ResourceSignal:
        Count: !Ref WebAsgMin
        Timeout: PT5M
    Metadata:
      'AWS::CloudFormation::Designer':
        id: 06bfa836-7465-42ba-b6ca-a527b1e774f1
  WebLaunchConfiguration55:
    Condition: PHP55
    Type: 'AWS::AutoScaling::LaunchConfiguration'
    Metadata:
      'AWS::CloudFormation::Init':
        configSets:
          deploy_webserver:
            - install_webserver
            - build_cacheclient
            - build_wordpress
            - build_opcache
            - download_aws_ini
            - install_aws_ini
            - install_cacheclient
            - install_wordpress
            - install_opcache
            - start_webserver
        install_webserver:
          packages:
            yum:
              awslogs: []
              httpd24: []
              mysql56: []
              php55: []
              php55-devel: []
              php55-pear: []
              php55-mysqlnd: []
          files:
            /tmp/create_site_conf.sh:
              content: !Join 
                - ''
                - - |
                    #!/bin/bash -xe
                  - 'if [ ! -f /etc/httpd/conf.d/'
                  - !Ref WPDirectory
                  - |
                    .conf ]; then
                  - '   touch /etc/httpd/conf.d/'
                  - !Ref WPDirectory
                  - |
                    .conf
                  - '   echo ''ServerName 127.0.0.1:80'' >> /etc/httpd/conf.d/'
                  - !Ref WPDirectory
                  - |
                    .conf
                  - '   echo ''DocumentRoot /var/www/wordpress/'
                  - !Ref WPDirectory
                  - ''' >> /etc/httpd/conf.d/'
                  - !Ref WPDirectory
                  - |
                    .conf
                  - '   echo ''<Directory /var/www/wordpress/'
                  - !Ref WPDirectory
                  - '>'' >> /etc/httpd/conf.d/'
                  - !Ref WPDirectory
                  - |
                    .conf
                  - '   echo ''  Options Indexes FollowSymLinks'' >> /etc/httpd/conf.d/'
                  - !Ref WPDirectory
                  - |
                    .conf
                  - '   echo ''  AllowOverride All'' >> /etc/httpd/conf.d/'
                  - !Ref WPDirectory
                  - |
                    .conf
                  - '   echo ''  Require all granted'' >> /etc/httpd/conf.d/'
                  - !Ref WPDirectory
                  - |
                    .conf
                  - '   echo ''</Directory>'' >> /etc/httpd/conf.d/'
                  - !Ref WPDirectory
                  - |
                    .conf
                  - |
                    fi
              mode: 320
              owner: root
              group: root
          commands:
            create_site_conf:
              command: ./create_site_conf.sh
              cwd: /tmp
              ignoreErrors: false
        build_cacheclient:
          packages:
            yum:
              gcc-c++: []
          files:
            /tmp/install_cacheclient.sh:
              content: !Sub >
                #!/bin/bash -xe

                pecl install igbinary

                wget -P /tmp/
                https://s3.amazonaws.com/aws-refarch/wordpress/latest/bits/AmazonElastiCacheClusterClient-1.0.1-PHP55-64bit.tgz

                tar -xf
                '/tmp/AmazonElastiCacheClusterClient-1.0.1-PHP55-64bit.tgz'

                cp
                '/tmp/AmazonElastiCacheClusterClient-1.0.0/amazon-elasticache-cluster-client.so'
                /usr/lib64/php/5.5/modules/

                if [ ! -f /etc/php-5.5.d/50-memcached.ini ]; then
                    touch /etc/php-5.5.d/50-memcached.ini
                fi

                echo 'extension=igbinary.so;' >> /etc/php-5.5.d/50-memcached.ini

                echo
                'extension=/usr/lib64/php/5.5/modules/amazon-elasticache-cluster-client.so;'
                >> /etc/php-5.5.d/50-memcached.ini
              mode: 320
              owner: root
              group: root
        build_opcache:
          packages:
            yum:
              php55-opcache: []
          files:
            /tmp/install_opcache.sh:
              content: !Sub >
                #!/bin/bash -xe

                # create hidden opcache directory locally & change owner to
                apache

                if [ ! -d /var/www/.opcache ]; then                    
                    mkdir -p /var/www/.opcache
                fi

                # enable opcache in /etc/php-5.5.d/opcache.ini

                sed -i
                's/;opcache.file_cache=.*/opcache.file_cache=\/var\/www\/.opcache/'
                /etc/php-5.5.d/opcache.ini

                sed -i
                's/opcache.memory_consumption=.*/opcache.memory_consumption=512/'
                /etc/php-5.5.d/opcache.ini

                # download opcache-instance.php to verify opcache status

                if [ ! -f
                /var/www/wordpress/${WPDirectory}/opcache-instanceid.php ]; then
                    wget -P /var/www/wordpress/${WPDirectory}/ https://s3.amazonaws.com/aws-refarch/wordpress/latest/bits/opcache-instanceid.php
                fi
              mode: 320
              owner: root
              group: root
        build_wordpress:
          files:
            /tmp/install_wordpress.sh:
              content: !Join 
                - ''
                - - |
                    #!/bin/bash -xe
                  - |+

                  - |
                    # install wp-cli
                  - |
                    if [ ! -f /bin/wp/wp-cli.phar ]; then
                  - |2
                       curl -o /bin/wp https://raw.githubusercontent.com/wp-cli/builds/gh-pages/phar/wp-cli.phar
                  - |2
                       chmod +x /bin/wp
                  - |
                    fi
                  - |+

                  - |
                    # make site directory
                  - 'if [ ! -d /var/www/wordpress/'
                  - !Ref WPDirectory
                  - |2
                     ]; then
                  - '   mkdir -p /var/www/wordpress/'
                  - !Ref WPDirectory
                  - |+

                  - |+

                  - '   cd /var/www/wordpress/'
                  - !Ref WPDirectory
                  - |+

                  - |2
                       # install wordpress if not installed
                  - |2
                       # use public alb host name if wp domain name was empty
                  - |2
                       if ! $(wp core is-installed --allow-root); then
                  - '       wp core download --version='''
                  - !Ref WPVersion
                  - ''' --locale='''
                  - !Ref WPLocale
                  - |
                    ' --allow-root
                  - '       wp core config --dbname='''
                  - !Ref DatabaseName
                  - ''' --dbuser='''
                  - !Ref DatabaseMasterUsername
                  - ''' --dbpass='''
                  - !Ref DatabaseMasterPassword
                  - ''' --dbhost='''
                  - !Ref DatabaseClusterEndpointAddress
                  - |
                    ' --dbprefix=wp_ --allow-root
                  - '       wp core install --url='
                  - !If 
                    - NoWPDomainName
                    - !Ref PublicAlbHostname
                    - !Join 
                      - ''
                      - - '''http://www.'
                        - !Ref WPDomainName
                        - ''''
                  - ' --title='''
                  - !Ref WPTitle
                  - ''' --admin_user='''
                  - !Ref WPAdminUsername
                  - ''' --admin_password='''
                  - !Ref WPAdminPassword
                  - ''' --admin_email='''
                  - !Ref WPAdminEmail
                  - |
                    ' --skip-email --allow-root
                  - |2
                           wp plugin install w3-total-cache
                  - '       sed -i "/$table_prefix = ''wp_'';/ a \define(''WP_HOME'', ''http://'' . \$_SERVER[''HTTP_HOST'']); " /var/www/wordpress/'
                  - !Ref WPDirectory
                  - |
                    /wp-config.php
                  - '       sed -i "/$table_prefix = ''wp_'';/ a \define(''WP_SITEURL'', ''http://'' . \$_SERVER[''HTTP_HOST'']); " /var/www/wordpress/'
                  - !Ref WPDirectory
                  - |
                    /wp-config.php
                  - |2
                           # enable HTTPS in wp-config.php if ACM Public SSL Certificate parameter was not empty
                  - !If 
                    - NoSslCertificate
                    - !Join 
                      - ''
                      - - '       sed -i "/$table_prefix = ''wp_'';/ a \# No ACM Public SSL Certificate " /var/www/wordpress/'
                        - !Ref WPDirectory
                        - |
                          /wp-config.php
                    - !Join 
                      - ''
                      - - '       sed -i "/$table_prefix = ''wp_'';/ a \$_SERVER[''HTTPS''] = ''on'';" /var/www/wordpress/'
                        - !Ref WPDirectory
                        - |
                          /wp-config.php
                  - |+

                  - |2
                           # set permissions of wordpress site directories
                  - '       chown -R apache:apache /var/www/wordpress/'
                  - !Ref WPDirectory
                  - |+

                  - '       chmod u+wrx /var/www/wordpress/'
                  - !Ref WPDirectory
                  - |
                    /wp-content/*
                  - '       if [ ! -f /var/www/wordpress/'
                  - !Ref WPDirectory
                  - |
                    /opcache-instanceid.php ]; then
                  - '         wget -P /var/www/wordpress/'
                  - !Ref WPDirectory
                  - >
                    /
                    https://s3.amazonaws.com/aws-refarch/wordpress/latest/bits/opcache-instanceid.php
                  - |2
                           fi
                  - |2
                       fi
                  - |2
                       RESULT=$?
                  - |2
                       if [ $RESULT -eq 0 ]; then
                  - '       touch /var/www/wordpress/'
                  - !Ref WPDirectory
                  - |
                    /wordpress.initialized
                  - |2
                             else
                  - '       touch /var/www/wordpress/'
                  - !Ref WPDirectory
                  - |
                    /wordpress.failed
                  - |2
                       fi
                  - |
                    fi
              mode: 320
              owner: root
              group: root
        download_aws_ini:
          files:
            /tmp/download_aws_ini.sh:
              content: !Join 
                - ''
                - - |
                    #!/bin/bash -x
                  - |+

                  - 'wget -P /etc/php-5.5.d/ '
                  - !Ref PHPIniOverride
                  - |+

              mode: 320
              owner: root
              group: root
        install_aws_ini:
          commands:
            install_aws_ini:
              command: ./download_aws_ini.sh
              cwd: /tmp
              ignoreErrors: true
        install_wordpress:
          commands:
            install_wordpress:
              command: ./install_wordpress.sh
              cwd: /tmp
              ignoreErrors: false
        install_cacheclient:
          commands:
            install_cacheclient:
              command: ./install_cacheclient.sh
              cwd: /tmp
              ignoreErrors: false
        install_opcache:
          commands:
            install_opcache:
              command: ./install_opcache.sh
              cwd: /tmp
              ignoreErrors: false
        start_webserver:
          services:
            sysvinit:
              httpd:
                enabled: true
                ensureRunning: true
      'AWS::CloudFormation::Designer':
        id: 7124949a-aba7-4cfd-b132-e4c1b16f7b49
    Properties:
      IamInstanceProfile: !Ref WebInstanceProfile
      ImageId: !FindInMap 
        - RegionMap
        - !Ref 'AWS::Region'
        - AMI
      InstanceMonitoring: true
      InstanceType: !Ref WebInstanceType
      KeyName: !Ref EC2KeyName
      SecurityGroups:
        - !Ref WebSecurityGroup
      UserData:
        'Fn::Base64': !Sub >
          #!/bin/bash -xe

          yum update -y

          mkdir -p /var/www/wordpress

          mount -t nfs4 -o
          nfsvers=4.1,rsize=1048576,wsize=1048576,hard,timeo=600,retrans=2
          ${ElasticFileSystem}.efs.${AWS::Region}.amazonaws.com:/
          /var/www/wordpress

          /opt/aws/bin/cfn-init --configsets deploy_webserver --verbose --stack
          ${AWS::StackName} --resource WebLaunchConfiguration55 --region
          ${AWS::Region}

          /opt/aws/bin/cfn-signal --exit-code $? --stack ${AWS::StackName}
          --resource WebAutoScalingGroup --region ${AWS::Region}
  WebLaunchConfiguration56:
    Condition: PHP56
    Type: 'AWS::AutoScaling::LaunchConfiguration'
    Metadata:
      'AWS::CloudFormation::Init':
        configSets:
          deploy_webserver:
            - install_webserver
            - build_cacheclient
            - build_wordpress
            - build_opcache
            - download_aws_ini
            - install_aws_ini
            - install_cacheclient
            - install_wordpress
            - install_opcache
            - start_webserver
        install_webserver:
          packages:
            yum:
              awslogs: []
              httpd24: []
              mysql56: []
              php56: []
              php56-devel: []
              php56-pear: []
              php56-mysqlnd: []
          files:
            /tmp/create_site_conf.sh:
              content: !Join 
                - ''
                - - |
                    #!/bin/bash -xe
                  - 'if [ ! -f /etc/httpd/conf.d/'
                  - !Ref WPDirectory
                  - |
                    .conf ]; then
                  - '   touch /etc/httpd/conf.d/'
                  - !Ref WPDirectory
                  - |
                    .conf
                  - '   echo ''ServerName 127.0.0.1:80'' >> /etc/httpd/conf.d/'
                  - !Ref WPDirectory
                  - |
                    .conf
                  - '   echo ''DocumentRoot /var/www/wordpress/'
                  - !Ref WPDirectory
                  - ''' >> /etc/httpd/conf.d/'
                  - !Ref WPDirectory
                  - |
                    .conf
                  - '   echo ''<Directory /var/www/wordpress/'
                  - !Ref WPDirectory
                  - '>'' >> /etc/httpd/conf.d/'
                  - !Ref WPDirectory
                  - |
                    .conf
                  - '   echo ''  Options Indexes FollowSymLinks'' >> /etc/httpd/conf.d/'
                  - !Ref WPDirectory
                  - |
                    .conf
                  - '   echo ''  AllowOverride All'' >> /etc/httpd/conf.d/'
                  - !Ref WPDirectory
                  - |
                    .conf
                  - '   echo ''  Require all granted'' >> /etc/httpd/conf.d/'
                  - !Ref WPDirectory
                  - |
                    .conf
                  - '   echo ''</Directory>'' >> /etc/httpd/conf.d/'
                  - !Ref WPDirectory
                  - |
                    .conf
                  - |
                    fi
              mode: 320
              owner: root
              group: root
          commands:
            create_site_conf:
              command: ./create_site_conf.sh
              cwd: /tmp
              ignoreErrors: false
        build_cacheclient:
          packages:
            yum:
              gcc-c++: []
          files:
            /tmp/install_cacheclient.sh:
              content: !Sub >
                #!/bin/bash -xe

                pecl install igbinary

                wget -P /tmp/
                https://s3.amazonaws.com/aws-refarch/wordpress/latest/bits/AmazonElastiCacheClusterClient-1.0.0-PHP56-64bit.tgz

                tar -xf
                '/tmp/AmazonElastiCacheClusterClient-1.0.0-PHP56-64bit.tgz'

                cp
                '/tmp/AmazonElastiCacheClusterClient-1.0.0/amazon-elasticache-cluster-client.so'
                /usr/lib64/php/5.6/modules/

                if [ ! -f /etc/php-5.6.d/50-memcached.ini ]; then
                    touch /etc/php-5.6.d/50-memcached.ini
                fi

                echo 'extension=igbinary.so;' >> /etc/php-5.6.d/50-memcached.ini

                echo
                'extension=/usr/lib64/php/5.6/modules/amazon-elasticache-cluster-client.so;'
                >> /etc/php-5.6.d/50-memcached.ini
              mode: 320
              owner: root
              group: root
        build_opcache:
          packages:
            yum:
              php56-opcache: []
          files:
            /tmp/install_opcache.sh:
              content: !Sub >
                #!/bin/bash -xe

                # create hidden opcache directory locally & change owner to
                apache

                if [ ! -d /var/www/.opcache ]; then                    
                    mkdir -p /var/www/.opcache
                fi

                # enable opcache in /etc/php-5.6.d/opcache.ini

                sed -i
                's/;opcache.file_cache=.*/opcache.file_cache=\/var\/www\/.opcache/'
                /etc/php-5.6.d/10-opcache.ini

                sed -i
                's/opcache.memory_consumption=.*/opcache.memory_consumption=512/'
                /etc/php-5.6.d/10-opcache.ini

                # download opcache-instance.php to verify opcache status

                if [ ! -f
                /var/www/wordpress/${WPDirectory}/opcache-instanceid.php ]; then
                    wget -P /var/www/wordpress/${WPDirectory}/ https://s3.amazonaws.com/aws-refarch/wordpress/latest/bits/opcache-instanceid.php
                fi
              mode: 320
              owner: root
              group: root
        build_wordpress:
          files:
            /tmp/install_wordpress.sh:
              content: !Join 
                - ''
                - - |
                    #!/bin/bash -xe
                  - |+

                  - |
                    # install wp-cli
                  - |
                    if [ ! -f /bin/wp/wp-cli.phar ]; then
                  - |2
                       curl -o /bin/wp https://raw.githubusercontent.com/wp-cli/builds/gh-pages/phar/wp-cli.phar
                  - |2
                       chmod +x /bin/wp
                  - |
                    fi
                  - |+

                  - |
                    # make site directory
                  - 'if [ ! -d /var/www/wordpress/'
                  - !Ref WPDirectory
                  - |2
                     ]; then
                  - '   mkdir -p /var/www/wordpress/'
                  - !Ref WPDirectory
                  - |+

                  - |+

                  - '   cd /var/www/wordpress/'
                  - !Ref WPDirectory
                  - |+

                  - |2
                       # install wordpress if not installed
                  - |2
                       # use public alb host name if wp domain name was empty
                  - |2
                       if ! $(wp core is-installed --allow-root); then
                  - '       wp core download --version='''
                  - !Ref WPVersion
                  - ''' --locale='''
                  - !Ref WPLocale
                  - |
                    ' --allow-root
                  - '       wp core config --dbname='''
                  - !Ref DatabaseName
                  - ''' --dbuser='''
                  - !Ref DatabaseMasterUsername
                  - ''' --dbpass='''
                  - !Ref DatabaseMasterPassword
                  - ''' --dbhost='''
                  - !Ref DatabaseClusterEndpointAddress
                  - |
                    ' --dbprefix=wp_ --allow-root
                  - '       wp core install --url='
                  - !If 
                    - NoWPDomainName
                    - !Ref PublicAlbHostname
                    - !Join 
                      - ''
                      - - '''http://www.'
                        - !Ref WPDomainName
                        - ''''
                  - ' --title='''
                  - !Ref WPTitle
                  - ''' --admin_user='''
                  - !Ref WPAdminUsername
                  - ''' --admin_password='''
                  - !Ref WPAdminPassword
                  - ''' --admin_email='''
                  - !Ref WPAdminEmail
                  - |
                    ' --skip-email --allow-root
                  - |2
                           wp plugin install w3-total-cache
                  - '       sed -i "/$table_prefix = ''wp_'';/ a \define(''WP_HOME'', ''http://'' . \$_SERVER[''HTTP_HOST'']); " /var/www/wordpress/'
                  - !Ref WPDirectory
                  - |
                    /wp-config.php
                  - '       sed -i "/$table_prefix = ''wp_'';/ a \define(''WP_SITEURL'', ''http://'' . \$_SERVER[''HTTP_HOST'']); " /var/www/wordpress/'
                  - !Ref WPDirectory
                  - |
                    /wp-config.php
                  - |2
                           # enable HTTPS in wp-config.php if ACM Public SSL Certificate parameter was not empty
                  - !If 
                    - NoSslCertificate
                    - !Join 
                      - ''
                      - - '       sed -i "/$table_prefix = ''wp_'';/ a \# No ACM Public SSL Certificate " /var/www/wordpress/'
                        - !Ref WPDirectory
                        - |
                          /wp-config.php
                    - !Join 
                      - ''
                      - - '       sed -i "/$table_prefix = ''wp_'';/ a \$_SERVER[''HTTPS''] = ''on'';" /var/www/wordpress/'
                        - !Ref WPDirectory
                        - |
                          /wp-config.php
                  - |+

                  - |2
                           # set permissions of wordpress site directories
                  - '       chown -R apache:apache /var/www/wordpress/'
                  - !Ref WPDirectory
                  - |+

                  - '       chmod u+wrx /var/www/wordpress/'
                  - !Ref WPDirectory
                  - |
                    /wp-content/*
                  - '       if [ ! -f /var/www/wordpress/'
                  - !Ref WPDirectory
                  - |
                    /opcache-instanceid.php ]; then
                  - '         wget -P /var/www/wordpress/'
                  - !Ref WPDirectory
                  - >
                    /
                    https://s3.amazonaws.com/aws-refarch/wordpress/latest/bits/opcache-instanceid.php
                  - |2
                           fi
                  - |2
                       fi
                  - |2
                       RESULT=$?
                  - |2
                       if [ $RESULT -eq 0 ]; then
                  - '       touch /var/www/wordpress/'
                  - !Ref WPDirectory
                  - |
                    /wordpress.initialized
                  - |2
                             else
                  - '       touch /var/www/wordpress/'
                  - !Ref WPDirectory
                  - |
                    /wordpress.failed
                  - |2
                       fi
                  - |
                    fi
              mode: 320
              owner: root
              group: root
        download_aws_ini:
          files:
            /tmp/download_aws_ini.sh:
              content: !Join 
                - ''
                - - |
                    #!/bin/bash -x
                  - |+

                  - 'wget -P /etc/php-5.6.d/ '
                  - !Ref PHPIniOverride
                  - |+

              mode: 320
              owner: root
              group: root
        install_aws_ini:
          commands:
            install_aws_ini:
              command: ./download_aws_ini.sh
              cwd: /tmp
              ignoreErrors: true
        install_wordpress:
          commands:
            install_wordpress:
              command: ./install_wordpress.sh
              cwd: /tmp
              ignoreErrors: false
        install_cacheclient:
          commands:
            install_cacheclient:
              command: ./install_cacheclient.sh
              cwd: /tmp
              ignoreErrors: false
        install_opcache:
          commands:
            install_opcache:
              command: ./install_opcache.sh
              cwd: /tmp
              ignoreErrors: false
        start_webserver:
          services:
            sysvinit:
              httpd:
                enabled: true
                ensureRunning: true
      'AWS::CloudFormation::Designer':
        id: 1c425a30-ac1e-43bc-b916-1778f9606f70
    Properties:
      IamInstanceProfile: !Ref WebInstanceProfile
      ImageId: !FindInMap 
        - RegionMap
        - !Ref 'AWS::Region'
        - AMI
      InstanceMonitoring: true
      InstanceType: !Ref WebInstanceType
      KeyName: !Ref EC2KeyName
      SecurityGroups:
        - !Ref WebSecurityGroup
      UserData:
        'Fn::Base64': !Sub >
          #!/bin/bash -xe

          yum update -y

          mkdir -p /var/www/wordpress

          mount -t nfs4 -o
          nfsvers=4.1,rsize=1048576,wsize=1048576,hard,timeo=600,retrans=2
          ${ElasticFileSystem}.efs.${AWS::Region}.amazonaws.com:/
          /var/www/wordpress

          /opt/aws/bin/cfn-init --configsets deploy_webserver --verbose --stack
          ${AWS::StackName} --resource WebLaunchConfiguration56 --region
          ${AWS::Region}

          /opt/aws/bin/cfn-signal --exit-code $? --stack ${AWS::StackName}
          --resource WebAutoScalingGroup --region ${AWS::Region}
  WebLaunchConfiguration70:
    Condition: PHP70
    Type: 'AWS::AutoScaling::LaunchConfiguration'
    Metadata:
      'AWS::CloudFormation::Init':
        configSets:
          deploy_webserver:
            - install_webserver
            - build_cacheclient
            - build_wordpress
            - build_opcache
            - download_aws_ini
            - install_aws_ini
            - install_cacheclient
            - install_wordpress
            - install_opcache
            - start_webserver
        install_webserver:
          packages:
            yum:
              awslogs: []
              httpd24: []
              mysql56: []
              php70: []
              php70-devel: []
              php7-pear: []
              php70-mysqlnd: []
          files:
            /tmp/create_site_conf.sh:
              content: !Join 
                - ''
                - - |
                    #!/bin/bash -xe
                  - 'if [ ! -f /etc/httpd/conf.d/'
                  - !Ref WPDirectory
                  - |
                    .conf ]; then
                  - '   touch /etc/httpd/conf.d/'
                  - !Ref WPDirectory
                  - |
                    .conf
                  - '   echo ''ServerName 127.0.0.1:80'' >> /etc/httpd/conf.d/'
                  - !Ref WPDirectory
                  - |
                    .conf
                  - '   echo ''DocumentRoot /var/www/wordpress/'
                  - !Ref WPDirectory
                  - ''' >> /etc/httpd/conf.d/'
                  - !Ref WPDirectory
                  - |
                    .conf
                  - '   echo ''<Directory /var/www/wordpress/'
                  - !Ref WPDirectory
                  - '>'' >> /etc/httpd/conf.d/'
                  - !Ref WPDirectory
                  - |
                    .conf
                  - '   echo ''  Options Indexes FollowSymLinks'' >> /etc/httpd/conf.d/'
                  - !Ref WPDirectory
                  - |
                    .conf
                  - '   echo ''  AllowOverride All'' >> /etc/httpd/conf.d/'
                  - !Ref WPDirectory
                  - |
                    .conf
                  - '   echo ''  Require all granted'' >> /etc/httpd/conf.d/'
                  - !Ref WPDirectory
                  - |
                    .conf
                  - '   echo ''</Directory>'' >> /etc/httpd/conf.d/'
                  - !Ref WPDirectory
                  - |
                    .conf
                  - |
                    fi
              mode: 320
              owner: root
              group: root
          commands:
            create_site_conf:
              command: ./create_site_conf.sh
              cwd: /tmp
              ignoreErrors: false
        build_cacheclient:
          packages:
            yum:
              gcc-c++: []
          files:
            /tmp/install_cacheclient.sh:
              content: !Sub >
                #!/bin/bash -xe

                ln -s /usr/bin/pecl7 /usr/bin/pecl #just so pecl is available
                easily

                pecl7 install igbinary

                wget -P /tmp/
                https://s3.amazonaws.com/aws-refarch/wordpress/latest/bits/AmazonElastiCacheClusterClient-2.0.1-PHP70-64bit.tar.gz

                tar -xf
                '/tmp/AmazonElastiCacheClusterClient-2.0.1-PHP70-64bit.tar.gz'

                cp '/tmp/artifact/amazon-elasticache-cluster-client.so'
                /usr/lib64/php/7.0/modules/

                if [ ! -f /etc/php-7.0.d/50-memcached.ini ]; then
                    touch /etc/php-7.0.d/50-memcached.ini
                fi

                echo 'extension=igbinary.so;' >> /etc/php-7.0.d/50-memcached.ini

                echo
                'extension=/usr/lib64/php/7.0/modules/amazon-elasticache-cluster-client.so;'
                >> /etc/php-7.0.d/50-memcached.ini
              mode: 320
              owner: root
              group: root
        build_opcache:
          packages:
            yum:
              php70-opcache: []
          files:
            /tmp/install_opcache.sh:
              content: !Sub >
                #!/bin/bash -xe

                # create hidden opcache directory locally & change owner to
                apache

                if [ ! -d /var/www/.opcache ]; then                    
                    mkdir -p /var/www/.opcache
                fi

                # enable opcache in /etc/php-7.0.d/10-opcache.ini

                sed -i
                's/;opcache.file_cache=.*/opcache.file_cache=\/var\/www\/.opcache/'
                /etc/php-7.0.d/10-opcache.ini

                sed -i
                's/opcache.memory_consumption=.*/opcache.memory_consumption=512/'
                /etc/php-7.0.d/10-opcache.ini

                # download opcache-instance.php to verify opcache status

                if [ ! -f
                /var/www/wordpress/${WPDirectory}/opcache-instanceid.php ]; then
                    wget -P /var/www/wordpress/${WPDirectory}/ https://s3.amazonaws.com/aws-refarch/wordpress/latest/bits/opcache-instanceid.php
                fi
              mode: 320
              owner: root
              group: root
        build_wordpress:
          files:
            /tmp/install_wordpress.sh:
              content: !Join 
                - ''
                - - |
                    #!/bin/bash -xe
                  - |+

                  - |
                    # install wp-cli
                  - |
                    if [ ! -f /bin/wp/wp-cli.phar ]; then
                  - |2
                       curl -o /bin/wp https://raw.githubusercontent.com/wp-cli/builds/gh-pages/phar/wp-cli.phar
                  - |2
                       chmod +x /bin/wp
                  - |
                    fi
                  - |+

                  - |
                    # make site directory
                  - 'if [ ! -d /var/www/wordpress/'
                  - !Ref WPDirectory
                  - |2
                     ]; then
                  - '   mkdir -p /var/www/wordpress/'
                  - !Ref WPDirectory
                  - |+

                  - |+

                  - '   cd /var/www/wordpress/'
                  - !Ref WPDirectory
                  - |+

                  - |2
                       # install wordpress if not installed
                  - |2
                       # use public alb host name if wp domain name was empty
                  - |2
                       if ! $(wp core is-installed --allow-root); then
                  - '       wp core download --version='''
                  - !Ref WPVersion
                  - ''' --locale='''
                  - !Ref WPLocale
                  - |
                    ' --allow-root
                  - '       wp core config --dbname='''
                  - !Ref DatabaseName
                  - ''' --dbuser='''
                  - !Ref DatabaseMasterUsername
                  - ''' --dbpass='''
                  - !Ref DatabaseMasterPassword
                  - ''' --dbhost='''
                  - !Ref DatabaseClusterEndpointAddress
                  - |
                    ' --dbprefix=wp_ --allow-root
                  - '       wp core install --url='
                  - !If 
                    - NoWPDomainName
                    - !Ref PublicAlbHostname
                    - !Join 
                      - ''
                      - - '''http://www.'
                        - !Ref WPDomainName
                        - ''''
                  - ' --title='''
                  - !Ref WPTitle
                  - ''' --admin_user='''
                  - !Ref WPAdminUsername
                  - ''' --admin_password='''
                  - !Ref WPAdminPassword
                  - ''' --admin_email='''
                  - !Ref WPAdminEmail
                  - |
                    ' --skip-email --allow-root
                  - |2
                           wp plugin install w3-total-cache
                  - '       sed -i "/$table_prefix = ''wp_'';/ a \define(''WP_HOME'', ''http://'' . \$_SERVER[''HTTP_HOST'']); " /var/www/wordpress/'
                  - !Ref WPDirectory
                  - |
                    /wp-config.php
                  - '       sed -i "/$table_prefix = ''wp_'';/ a \define(''WP_SITEURL'', ''http://'' . \$_SERVER[''HTTP_HOST'']); " /var/www/wordpress/'
                  - !Ref WPDirectory
                  - |
                    /wp-config.php
                  - |2
                           # enable HTTPS in wp-config.php if ACM Public SSL Certificate parameter was not empty
                  - !If 
                    - NoSslCertificate
                    - !Join 
                      - ''
                      - - '       sed -i "/$table_prefix = ''wp_'';/ a \# No ACM Public SSL Certificate " /var/www/wordpress/'
                        - !Ref WPDirectory
                        - |
                          /wp-config.php
                    - !Join 
                      - ''
                      - - '       sed -i "/$table_prefix = ''wp_'';/ a \$_SERVER[''HTTPS''] = ''on'';" /var/www/wordpress/'
                        - !Ref WPDirectory
                        - |
                          /wp-config.php
                  - |+

                  - |2
                           # set permissions of wordpress site directories
                  - '       chown -R apache:apache /var/www/wordpress/'
                  - !Ref WPDirectory
                  - |+

                  - '       chmod u+wrx /var/www/wordpress/'
                  - !Ref WPDirectory
                  - |
                    /wp-content/*
                  - '       if [ ! -f /var/www/wordpress/'
                  - !Ref WPDirectory
                  - |
                    /opcache-instanceid.php ]; then
                  - '         wget -P /var/www/wordpress/'
                  - !Ref WPDirectory
                  - >
                    /
                    https://s3.amazonaws.com/aws-refarch/wordpress/latest/bits/opcache-instanceid.php
                  - |2
                           fi
                  - |2
                       fi
                  - |2
                       RESULT=$?
                  - |2
                       if [ $RESULT -eq 0 ]; then
                  - '       touch /var/www/wordpress/'
                  - !Ref WPDirectory
                  - |
                    /wordpress.initialized
                  - |2
                             else
                  - '       touch /var/www/wordpress/'
                  - !Ref WPDirectory
                  - |
                    /wordpress.failed
                  - |2
                       fi
                  - |
                    fi
              mode: 320
              owner: root
              group: root
        download_aws_ini:
          files:
            /tmp/download_aws_ini.sh:
              content: !Join 
                - ''
                - - |
                    #!/bin/bash -x
                  - |+

                  - 'wget -P /etc/php-7.0.d/ '
                  - !Ref PHPIniOverride
                  - |+

              mode: 320
              owner: root
              group: root
        install_aws_ini:
          commands:
            install_aws_ini:
              command: ./download_aws_ini.sh
              cwd: /tmp
              ignoreErrors: true
        install_wordpress:
          commands:
            install_wordpress:
              command: ./install_wordpress.sh
              cwd: /tmp
              ignoreErrors: false
        install_cacheclient:
          commands:
            install_cacheclient:
              command: ./install_cacheclient.sh
              cwd: /tmp
              ignoreErrors: false
        install_opcache:
          commands:
            install_opcache:
              command: ./install_opcache.sh
              cwd: /tmp
              ignoreErrors: false
        start_webserver:
          services:
            sysvinit:
              httpd:
                enabled: true
                ensureRunning: true
      'AWS::CloudFormation::Designer':
        id: d00ad01c-fa44-49bb-829a-ffb890e3223b
    Properties:
      IamInstanceProfile: !Ref WebInstanceProfile
      ImageId: !FindInMap 
        - RegionMap
        - !Ref 'AWS::Region'
        - AMI
      InstanceMonitoring: true
      InstanceType: !Ref WebInstanceType
      KeyName: !Ref EC2KeyName
      SecurityGroups:
        - !Ref WebSecurityGroup
      UserData:
        'Fn::Base64': !Sub >
          #!/bin/bash -xe

          yum update -y

          mkdir -p /var/www/wordpress

          mount -t nfs4 -o
          nfsvers=4.1,rsize=1048576,wsize=1048576,hard,timeo=600,retrans=2
          ${ElasticFileSystem}.efs.${AWS::Region}.amazonaws.com:/
          /var/www/wordpress

          /opt/aws/bin/cfn-init --configsets deploy_webserver --verbose --stack
          ${AWS::StackName} --resource WebLaunchConfiguration70 --region
          ${AWS::Region}

          /opt/aws/bin/cfn-signal --exit-code $? --stack ${AWS::StackName}
          --resource WebAutoScalingGroup --region ${AWS::Region}
WebLaunchConfiguration73:
  Condition: PHP73
  Type: 'AWS::AutoScaling::LaunchConfiguration'
  Metadata:
    'AWS::CloudFormation::Init':
      configSets:
        deploy_webserver:
          - install_webserver
          - build_cacheclient
          - build_wordpress
          - build_opcache
          - download_aws_ini
          - install_aws_ini
          - install_cacheclient
          - install_wordpress
          - install_opcache
          - start_webserver
      install_webserver:
        packages:
          yum:
            awslogs: []
            httpd24: []
            mysql57: []
            php73: []
            php73-devel: []
            php7-pear: []
            php73-mysqlnd: []
        files:
          /tmp/create_site_conf.sh:
            content: !Join 
              - ''
              - - |
                  #!/bin/bash -xe
                - 'if [ ! -f /etc/httpd/conf.d/'
                - !Ref WPDirectory
                - |
                  .conf ]; then
                - '   touch /etc/httpd/conf.d/'
                - !Ref WPDirectory
                - |
                  .conf
                - '   echo ''ServerName 127.0.0.1:80'' >> /etc/httpd/conf.d/'
                - !Ref WPDirectory
                - |
                  .conf
                - '   echo ''DocumentRoot /var/www/wordpress/'
                - !Ref WPDirectory
                - ''' >> /etc/httpd/conf.d/'
                - !Ref WPDirectory
                - |
                  .conf
                - '   echo ''<Directory /var/www/wordpress/'
                - !Ref WPDirectory
                - '>'' >> /etc/httpd/conf.d/'
                - !Ref WPDirectory
                - |
                  .conf
                - '   echo ''  Options Indexes FollowSymLinks'' >> /etc/httpd/conf.d/'
                - !Ref WPDirectory
                - |
                  .conf
                - '   echo ''  AllowOverride All'' >> /etc/httpd/conf.d/'
                - !Ref WPDirectory
                - |
                  .conf
                - '   echo ''  Require all granted'' >> /etc/httpd/conf.d/'
                - !Ref WPDirectory
                - |
                  .conf
                - '   echo ''</Directory>'' >> /etc/httpd/conf.d/'
                - !Ref WPDirectory
                - |
                  .conf
                - |
                  fi
            mode: 320
            owner: root
            group: root
        commands:
          create_site_conf:
            command: ./create_site_conf.sh
            cwd: /tmp
            ignoreErrors: false
      build_cacheclient:
        packages:
          yum:
            gcc-c++: []
        files:
          /tmp/install_cacheclient.sh:
            content: !Sub >
              #!/bin/bash -xe

              ln -s /usr/bin/pecl7 /usr/bin/pecl #just so pecl is available
              easily

              pecl7 install igbinary

              wget -P /tmp/
              https://github.com/davesc63/aws-refarch-wordpress/blob/master/bits/AmazonElastiCacheClusterClient-PHP73-64bit-libmemcached-1.0.18.tar.gz?raw=true

              tar -xf
              '/tmp/AmazonElastiCacheClusterClient-PHP73-64bit-libmemcached-1.0.18.tar.gz'

              cp '/tmp/artifact/amazon-elasticache-cluster-client.so'
              /usr/lib64/php/7.0/modules/

              if [ ! -f /etc/php-7.3.d/50-memcached.ini ]; then
                  touch /etc/php-7.3.d/50-memcached.ini
              fi

              echo 'extension=igbinary.so;' >> /etc/php-7.3.d/50-memcached.ini

              echo
              'extension=/usr/lib64/php/7.3/modules/amazon-elasticache-cluster-client.so;'
              >> /etc/php-7.3.d/50-memcached.ini
            mode: 320
            owner: root
            group: root
      build_opcache:
        packages:
          yum:
            php70-opcache: []
        files:
          /tmp/install_opcache.sh:
            content: !Sub >
              #!/bin/bash -xe

              # create hidden opcache directory locally & change owner to apache

              if [ ! -d /var/www/.opcache ]; then                    
                  mkdir -p /var/www/.opcache
              fi

              # enable opcache in /etc/php-7.3.d/10-opcache.ini

              sed -i
              's/;opcache.file_cache=.*/opcache.file_cache=\/var\/www\/.opcache/'
              /etc/php-7.3.d/10-opcache.ini

              sed -i
              's/opcache.memory_consumption=.*/opcache.memory_consumption=512/'
              /etc/php-7.3.d/10-opcache.ini

              # download opcache-instance.php to verify opcache status

              if [ ! -f /var/www/wordpress/${WPDirectory}/opcache-instanceid.php
              ]; then
                  wget -P /var/www/wordpress/${WPDirectory}/ https://s3.amazonaws.com/aws-refarch/wordpress/latest/bits/opcache-instanceid.php
              fi
            mode: 320
            owner: root
            group: root
      build_wordpress:
        files:
          /tmp/install_wordpress.sh:
            content: !Join 
              - ''
              - - |
                  #!/bin/bash -xe
                - |+

                - |
                  # install wp-cli
                - |
                  if [ ! -f /bin/wp/wp-cli.phar ]; then
                - |2
                     curl -o /bin/wp https://raw.githubusercontent.com/wp-cli/builds/gh-pages/phar/wp-cli.phar
                - |2
                     chmod +x /bin/wp
                - |
                  fi
                - |+

                - |
                  # make site directory
                - 'if [ ! -d /var/www/wordpress/'
                - !Ref WPDirectory
                - |2
                   ]; then
                - '   mkdir -p /var/www/wordpress/'
                - !Ref WPDirectory
                - |+

                - |+

                - '   cd /var/www/wordpress/'
                - !Ref WPDirectory
                - |+

                - |2
                     # install wordpress if not installed
                - |2
                     # use public alb host name if wp domain name was empty
                - |2
                     if ! $(wp core is-installed --allow-root); then
                - '       wp core download --version='''
                - !Ref WPVersion
                - ''' --locale='''
                - !Ref WPLocale
                - |
                  ' --allow-root
                - '       wp core config --dbname='''
                - !Ref DatabaseName
                - ''' --dbuser='''
                - !Ref DatabaseMasterUsername
                - ''' --dbpass='''
                - !Ref DatabaseMasterPassword
                - ''' --dbhost='''
                - !Ref DatabaseClusterEndpointAddress
                - |
                  ' --dbprefix=wp_ --allow-root
                - '       wp core install --url='
                - !If 
                  - NoWPDomainName
                  - !Ref PublicAlbHostname
                  - !Join 
                    - ''
                    - - '''http://www.'
                      - !Ref WPDomainName
                      - ''''
                - ' --title='''
                - !Ref WPTitle
                - ''' --admin_user='''
                - !Ref WPAdminUsername
                - ''' --admin_password='''
                - !Ref WPAdminPassword
                - ''' --admin_email='''
                - !Ref WPAdminEmail
                - |
                  ' --skip-email --allow-root
                - |2
                         wp plugin install w3-total-cache
                - '       sed -i "/$table_prefix = ''wp_'';/ a \define(''WP_HOME'', ''http://'' . \$_SERVER[''HTTP_HOST'']); " /var/www/wordpress/'
                - !Ref WPDirectory
                - |
                  /wp-config.php
                - '       sed -i "/$table_prefix = ''wp_'';/ a \define(''WP_SITEURL'', ''http://'' . \$_SERVER[''HTTP_HOST'']); " /var/www/wordpress/'
                - !Ref WPDirectory
                - |
                  /wp-config.php
                - |2
                         # enable HTTPS in wp-config.php if ACM Public SSL Certificate parameter was not empty
                - !If 
                  - NoSslCertificate
                  - !Join 
                    - ''
                    - - '       sed -i "/$table_prefix = ''wp_'';/ a \# No ACM Public SSL Certificate " /var/www/wordpress/'
                      - !Ref WPDirectory
                      - |
                        /wp-config.php
                  - !Join 
                    - ''
                    - - '       sed -i "/$table_prefix = ''wp_'';/ a \$_SERVER[''HTTPS''] = ''on'';" /var/www/wordpress/'
                      - !Ref WPDirectory
                      - |
                        /wp-config.php
                - |+

                - |2
                         # set permissions of wordpress site directories
                - '       chown -R apache:apache /var/www/wordpress/'
                - !Ref WPDirectory
                - |+

                - '       chmod u+wrx /var/www/wordpress/'
                - !Ref WPDirectory
                - |
                  /wp-content/*
                - '       if [ ! -f /var/www/wordpress/'
                - !Ref WPDirectory
                - |
                  /opcache-instanceid.php ]; then
                - '         wget -P /var/www/wordpress/'
                - !Ref WPDirectory
                - >
                  /
                  https://s3.amazonaws.com/aws-refarch/wordpress/latest/bits/opcache-instanceid.php
                - |2
                         fi
                - |2
                     fi
                - |2
                     RESULT=$?
                - |2
                     if [ $RESULT -eq 0 ]; then
                - '       touch /var/www/wordpress/'
                - !Ref WPDirectory
                - |
                  /wordpress.initialized
                - |2
                           else
                - '       touch /var/www/wordpress/'
                - !Ref WPDirectory
                - |
                  /wordpress.failed
                - |2
                     fi
                - |
                  fi
            mode: 320
            owner: root
            group: root
      download_aws_ini:
        files:
          /tmp/download_aws_ini.sh:
            content: !Join 
              - ''
              - - |
                  #!/bin/bash -x
                - |+

                - 'wget -P /etc/php-7.3.d/ '
                - !Ref PHPIniOverride
                - |+

            mode: 320
            owner: root
            group: root
      install_aws_ini:
        commands:
          install_aws_ini:
            command: ./download_aws_ini.sh
            cwd: /tmp
            ignoreErrors: true
      install_wordpress:
        commands:
          install_wordpress:
            command: ./install_wordpress.sh
            cwd: /tmp
            ignoreErrors: false
      install_cacheclient:
        commands:
          install_cacheclient:
            command: ./install_cacheclient.sh
            cwd: /tmp
            ignoreErrors: false
      install_opcache:
        commands:
          install_opcache:
            command: ./install_opcache.sh
            cwd: /tmp
            ignoreErrors: false
      start_webserver:
        services:
          sysvinit:
            httpd:
              enabled: true
              ensureRunning: true
  Properties:
    IamInstanceProfile: !Ref WebInstanceProfile
    ImageId: !FindInMap 
      - RegionMap
      - !Ref 'AWS::Region'
      - AMI
    InstanceMonitoring: true
    InstanceType: !Ref WebInstanceType
    KeyName: !Ref EC2KeyName
    SecurityGroups:
      - !Ref WebSecurityGroup
    UserData:
      'Fn::Base64': !Sub >
        #!/bin/bash -xe

        yum update -y

        mkdir -p /var/www/wordpress

        mount -t nfs4 -o
        nfsvers=4.1,rsize=1048576,wsize=1048576,hard,timeo=600,retrans=2
        ${ElasticFileSystem}.efs.${AWS::Region}.amazonaws.com:/
        /var/www/wordpress

        /opt/aws/bin/cfn-init --configsets deploy_webserver --verbose --stack
        ${AWS::StackName} --resource WebLaunchConfiguration73 --region
        ${AWS::Region}

        /opt/aws/bin/cfn-signal --exit-code $? --stack ${AWS::StackName}
        --resource WebAutoScalingGroup --region ${AWS::Region}
Outputs:
  Opcachestatus:
    Value: !Join 
      - ''
      - - !Ref PublicAlbHostname
        - /opcache-instanceid.php
